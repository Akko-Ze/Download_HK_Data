name: â˜ï¸ Auto Download HK Weather Data

on:
  schedule:
    - cron: "0 0 * * *"  # æ¯å¤© UTC 0 ç‚¹ï¼ˆé¦™æ¸¯/å°åŒ—æ—¶é—´æ—©ä¸Š 8 ç‚¹ï¼‰
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ğŸ“š Install dependencies
        run: pip install -r requirements.txt

      # âœ… ä½¿ç”¨æœåŠ¡è´¦å·è®¤è¯ï¼ˆä»£æ›¿ credentials.json / token.jsonï¼‰
      - name: ğŸ”‘ Prepare Google Service Account
        env:
          GDRIVE_SERVICE_ACCOUNT: ${{ secrets.GDRIVE_SERVICE_ACCOUNT }}
        run: |
          echo "$GDRIVE_SERVICE_ACCOUNT" > service_account.json

      - name: â–¶ï¸ Run main script
        run: |
          python download_and_upload.py > run_log.txt 2>&1

      - name: ğŸ§¾ Detect errors
        id: check_log
        run: |
          if grep -iE "error|exception|âŒ|failed" run_log.txt; then
            echo "has_error=true" >> $GITHUB_OUTPUT
          else
            echo "has_error=false" >> $GITHUB_OUTPUT
          fi

      # âœ… æ”¹æˆç”¨æœåŠ¡è´¦å·ä¸Šä¼ æ—¥å¿—
      - name: â˜ï¸ Upload error log to Google Drive (if any)
        if: steps.check_log.outputs.has_error == 'true'
        run: |
          pip install google-api-python-client google-auth
          python - <<'PYCODE'
          from google.oauth2 import service_account
          from googleapiclient.discovery import build
          from googleapiclient.http import MediaFileUpload

          SCOPES = ["https://www.googleapis.com/auth/drive.file"]
          creds = service_account.Credentials.from_service_account_file("service_account.json", scopes=SCOPES)
          service = build("drive", "v3", credentials=creds)

          file_metadata = {"name": "weather_error_log.txt"}
          media = MediaFileUpload("run_log.txt", mimetype="text/plain")
          uploaded = service.files().create(body=file_metadata, media_body=media, fields="id").execute()

          print(f"â˜ï¸ Error log uploaded to Google Drive: {uploaded.get('id')}")
          PYCODE

      - name: ğŸ“¤ Upload log to GitHub (for debugging)
        uses: actions/upload-artifact@v4
        with:
          name: workflow-log
          path: run_log.txt

