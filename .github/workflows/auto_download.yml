name: â˜ï¸ Auto Download HK Weather Data

on:
  schedule:
    - cron: "0 0 * * *"  # æ¯å¤© UTC 0 ç‚¹ï¼ˆé¦™æ¸¯/å°åŒ—æ—¶é—´æ—©ä¸Š 8 ç‚¹ï¼‰
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ğŸ“š Install dependencies
        run: pip install -r requirements.txt

      # âœ… å‡†å¤‡ Google OAuth credentials
      - name: ğŸ”‘ Prepare Google OAuth credentials
        env:
          GDRIVE_CREDENTIALS: ${{ secrets.GDRIVE_CREDENTIALS }}
          GDRIVE_TOKEN: ${{ secrets.GDRIVE_TOKEN }}
        run: |
          echo "$GDRIVE_CREDENTIALS" | jq '.' > credentials.json
          echo "$GDRIVE_TOKEN" | jq '.' > token.json

      # âœ… è¿è¡Œä¸‹è½½ä¸Šä¼ è„šæœ¬
      - name: â–¶ï¸ Run main script
        run: python download_and_upload.py > run_log.txt 2>&1
        continue-on-error: true

      # âœ… æ£€æµ‹è„šæœ¬æ˜¯å¦æŠ¥é”™æˆ–æµ‹è¯•é‚®ä»¶æ¨¡å¼
      - name: ğŸ§¾ Detect errors
        id: check_log
        run: |
          # è®¾ç½®æµ‹è¯•æ¨¡å¼: true=å¼ºåˆ¶è§¦å‘é‚®ä»¶, false=æ­£å¸¸æ—¥å¿—æ£€æµ‹
          TEST_MODE=false

          if [ "$TEST_MODE" = "true" ]; then
            echo "has_error=true" >> $GITHUB_OUTPUT
            echo "âœ… TEST_MODE=true: å¼ºåˆ¶è§¦å‘é‚®ä»¶" >> run_log.txt
          else
            if grep -iE "error|exception|âŒ|failed" run_log.txt; then
              echo "has_error=true" >> $GITHUB_OUTPUT
            else
              echo "has_error=false" >> $GITHUB_OUTPUT
            fi
          fi

      # âœ… ä¸Šä¼ é”™è¯¯æ—¥å¿—åˆ° Google Driveï¼ˆå¦‚æœæœ‰é”™è¯¯ï¼‰
      - name: â˜ï¸ Upload error log to Google Drive (if any)
        if: steps.check_log.outputs.has_error == 'true'
        run: |
          pip install google-api-python-client google-auth google-auth-oauthlib
          python - <<'PYCODE'
          from google.oauth2.credentials import Credentials
          from googleapiclient.discovery import build
          from googleapiclient.http import MediaFileUpload

          SCOPES = ["https://www.googleapis.com/auth/drive.file"]
          creds = Credentials.from_authorized_user_file("token.json", SCOPES)
          service = build("drive", "v3", credentials=creds)

          file_metadata = {"name": "weather_error_log.txt"}
          media = MediaFileUpload("run_log.txt", mimetype="text/plain")
          uploaded = service.files().create(body=file_metadata, media_body=media, fields="id").execute()
          print(f"â˜ï¸ Error log uploaded to Google Drive: {uploaded.get('id')}")
          PYCODE

      # âœ… å‘é€é”™è¯¯é‚®ä»¶åˆ°ç½‘æ˜“é‚®ç®±
      - name: ğŸ“§ Send error email to NetEase
        if: steps.check_log.outputs.has_error == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.163.com
          server_port: 465
          username: ${{ secrets.EMAIL_USER }}
          password: ${{ secrets.EMAIL_PASS }}
          subject: "[Weather Download] âŒ è‡ªåŠ¨ä»»åŠ¡å‡ºé”™"
          body: "è‡ªåŠ¨ä¸‹è½½ä»»åŠ¡å‡ºç°é”™è¯¯ï¼Œè¯·æŸ¥çœ‹é™„ä»¶æ—¥å¿—ã€‚"
          to: Mr_zhaoze@163.com
          from: ${{ secrets.EMAIL_USER }}
          attachments: run_log.txt

      # âœ… ä¸Šä¼ æ—¥å¿—åˆ° GitHubï¼ˆè°ƒè¯•ç”¨ï¼‰
      - name: ğŸ“¤ Upload log to GitHub
        uses: actions/upload-artifact@v4
        with:
          name: workflow-log
          path: run_log.txt
